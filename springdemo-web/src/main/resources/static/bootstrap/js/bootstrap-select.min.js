
(function($){
    $.fn.extend({
        pageination: function(options){
            //面向对象的写法
            new selectUl(this,options);
        }
    });

    var selectUl = function(ele,options){
        if(options==null)
            alert("arg error")
        this.element=ele;
        this.options={
            callback:function(){}
        };
        this.options=$.extend({},this.options,options);
        this.init();
    }

    //初始化对象
    selectUl.prototype={
        init:function(){
            //初始化
            this.createHtml();
        },
        createHtml:function(){
            var that = this.element;
            var thisobj = this;

            if (that.parent().hasClass("select_wrapper")) {
                if (that.children().length > 0) {
                    that.parent().children("span").text(that.find(':selected').text());
                } else {
                    that.parent().children("span").text('无选项');
                }

                that.parent().children('.select_inner').html("");
            } else {
                that.wrap('<div class="select_wrapper"></div>');
                if (that.children().length > 0) {
                    that.parent().prepend('<span class="spanItemText">' + that.find(':selected').text() + '</span>');
                } else {
                    that.parent().prepend('<span>无选项</span>');
                }

                that.parent().append('<ul class="select_inner"></ul>');
            }



            that.parent().children('span').width(100);
            that.css('display', 'none');

            var maxlen = 1;
            if (that.children().length > 0) {
                that.children().each(function(idx,obb){
                    var opttext = $(obb).text();
                    var optval = $(obb).val();
                    maxlen = opttext.length > maxlen ? opttext.length : maxlen;
                    that.parent().children('.select_inner').append('<li id="' + optval + '">' + opttext + '</li>');
                });
            }
            if (maxlen == "1") {
                that.parent().children('.select_inner').width("100%");
                that.parent().children('.select_inner').css({left:0,right:"auto"});
            } else if (that.parent().parent().hasClass("flleft")) {
                that.parent().children('.select_inner').width((maxlen+2)+"em");
                that.parent().children('.select_inner').css({left:0,right:"auto"});
            } else {
                that.parent().children('.select_inner').width((maxlen+2)+"em");
                if (that.parent().children('.select_inner').width() > that.width()) {
                    that.parent().children('.select_inner').css({left:"auto",right:0});
                }
            }


            // 列表值改变
            that.parent().find('li').unbind();
            that.parent().find('li').on('click', function (){
                if (that.parent().children('span').text() != $(this).text()) {
                    var cur = $(this).attr('id');
                    that.parent().children('span').text($(this).text());
                    that.children().removeAttr('selected');
                    that.children('[value="'+cur+'"]').attr('selected','selected');
                    // 值发生改变时
                    thisobj.changeVal(cur,$(this).text());
                }
            });

            // 展开折叠
            that.parent().unbind();
            that.parent().on('click', function (){
                var thistf = $(this).find('ul').is(":hidden");
                $(".select_wrapper").removeClass("select-hover");
                $(".select_wrapper").find('ul').slideUp();
                $("body").find('.select-bg').remove();
                $("body").find('.select-bg2').remove();

                if (thistf) {
                    $(this).addClass("select-hover");
                    $(this).find('ul').slideDown();
                    $("body").append('<div class="select-bg"></div>');
                    $(this).after('<div class="select-bg2"></div>');
                }
            });
        },
        changeVal:function(id,text){
            this.options.callback(id,text);
        }
    }

    $(document).on("click",".select-bg",function () {
        $(".select_wrapper").removeClass("select-hover");
        $(".select_wrapper").find('ul').slideUp();
        $("body").find('.select-bg').remove();
        $("body").find('.select-bg2').remove();
    });
    $(document).on("click",".select-bg2",function () {
        $(".select_wrapper").removeClass("select-hover");
        $(".select_wrapper").find('ul').slideUp();
        $("body").find('.select-bg').remove();
        $("body").find('.select-bg2').remove();
    });

})(jQuery);
